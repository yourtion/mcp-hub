name: Test Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-coverage:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: å®‰è£… pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: è·å– pnpm store ç›®å½•
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
        
    - name: è®¾ç½® pnpm ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
          
    - name: å®‰è£…ä¾èµ–
      run: pnpm install --frozen-lockfile
      
    - name: æ„å»ºé¡¹ç›®
      run: pnpm build
      
    - name: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: pnpm ci:test
      
    - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: pnpm coverage:merge && pnpm coverage:report
      
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° Codecov
      uses: codecov/codecov-action@v3
      with:
        files: |
          ./backend/coverage/lcov.info
          ./packages/core/coverage/lcov.info
          ./packages/cli/coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        verbose: true
        
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šä½œä¸ºæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-reports-${{ matrix.node-version }}
        path: |
          ./coverage/
          ./backend/coverage/
          ./packages/core/coverage/
          ./packages/cli/coverage/
        retention-days: 30
        
    - name: è¯„è®º PR è¦†ç›–ç‡æŠ¥å‘Š
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // è¯»å–å„åŒ…çš„è¦†ç›–ç‡æŠ¥å‘Š
          const packages = [
            { name: 'Backend API', path: './backend/coverage/coverage-summary.json', threshold: 80 },
            { name: 'Core Package', path: './packages/core/coverage/coverage-summary.json', threshold: 85 },
            { name: 'CLI Package', path: './packages/cli/coverage/coverage-summary.json', threshold: 85 }
          ];
          
          let comment = '## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š\n\n';
          
          for (const pkg of packages) {
            if (fs.existsSync(pkg.path)) {
              try {
                const summary = JSON.parse(fs.readFileSync(pkg.path, 'utf8'));
                const { total } = summary;
                
                comment += `### ${pkg.name}\n\n`;
                comment += '| æŒ‡æ ‡ | è¦†ç›–ç‡ | é˜ˆå€¼ | çŠ¶æ€ |\n';
                comment += '|------|--------|------|------|\n';
                comment += `| è¡Œè¦†ç›–ç‡ | ${total.lines.pct.toFixed(2)}% | ${pkg.threshold}% | ${total.lines.pct >= pkg.threshold ? 'âœ…' : 'âŒ'} |\n`;
                comment += `| å‡½æ•°è¦†ç›–ç‡ | ${total.functions.pct.toFixed(2)}% | ${pkg.threshold}% | ${total.functions.pct >= pkg.threshold ? 'âœ…' : 'âŒ'} |\n`;
                comment += `| è¯­å¥è¦†ç›–ç‡ | ${total.statements.pct.toFixed(2)}% | ${pkg.threshold}% | ${total.statements.pct >= pkg.threshold ? 'âœ…' : 'âŒ'} |\n`;
                comment += `| åˆ†æ”¯è¦†ç›–ç‡ | ${total.branches.pct.toFixed(2)}% | ${pkg.threshold}% | ${total.branches.pct >= pkg.threshold ? 'âœ…' : 'âŒ'} |\n\n`;
              } catch (error) {
                comment += `### ${pkg.name}\nâŒ æ— æ³•è¯»å–è¦†ç›–ç‡æŠ¥å‘Š\n\n`;
              }
            } else {
              comment += `### ${pkg.name}\nâš ï¸ è¦†ç›–ç‡æŠ¥å‘Šä¸å­˜åœ¨\n\n`;
            }
          }
          
          comment += 'ğŸ’¡ **æç¤º**: æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šè¯·ä¸‹è½½æ„å»ºäº§ç‰©ä¸­çš„ HTML æŠ¥å‘Šã€‚\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });